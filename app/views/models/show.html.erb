<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= @model.name %> - –ü—Ä–æ—Å–º–æ—Ç—Ä 3D –º–æ–¥–µ–ª–∏</title>

  <!-- Babylon Viewer -->
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@babylonjs/viewer@7.52.1/dist/babylon-viewer.esm.min.js"></script>
</head>

<%= stylesheet_link_tag 'models', media: 'all' %>

<body>
  <div class="model-container">
    <h2 class="model-title">–ú–æ–¥–µ–ª—å: <%= @model.name %></h2>
    <div class="model-description">
      <p>–û–ø–∏—Å–∞–Ω–∏–µ: <%= @model.description %></p>
    </div>

    <div class="viewer-container">
      <babylon-viewer
        source="<%= rails_blob_url(@model.file) %>"
        environment="auto"
        camera-auto-orbit
        camera-auto-orbit-speed="0.080"
        skybox="https://assets.babylonjs.com/environments/environmentSpecular.env">
      </babylon-viewer>
    </div>

    <hr class="separator">

    <div class="action-buttons">
      <% if @model.file.attached? %>
        <a class="download-link" href="<%= rails_blob_path(@model.file, disposition: 'attachment') %>">
          üì• –°–∫–∞—á–∞—Ç—å –º–æ–¥–µ–ª—å
        </a>
      <% else %>
        <p>–§–∞–π–ª –º–æ–¥–µ–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>
      <% end %>
      <button class="embed-button" id="openAdvancedEmbed">üîó Embed</button>
    </div>

    <div class="model-analysis">
      <h3>–ê–Ω–∞–ª–∏–∑ –º–æ–¥–µ–ª–∏</h3>
      <div id="analysisResults">
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
      </div>
      <button id="runAnalysis">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
    </div>    
  </div>

  <!-- Overlay –∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è Embed -->
  <div class="overlay" id="overlay">
    <div class="advanced-embed-modal" id="advancedEmbedModal">
      <!-- –ö–Ω–æ–ø–∫–∞-–∫—Ä–µ—Å—Ç–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è -->
      <button class="close-embed-modal" id="closeModal">‚úï</button>

      <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –º–∏–Ω–∏-–ø—Ä–æ—Å–º–æ—Ç—Ä –º–æ–¥–µ–ª–∏ -->
      <div class="embed-viewer-container">
        <babylon-viewer
          id="miniViewer"
          environment="auto"
          camera-auto-orbit
          camera-auto-orbit-speed="0.070"
          skybox="https://assets.babylonjs.com/environments/environmentSpecular.env">
        </babylon-viewer>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ embed-–∫–æ–¥ -->
      <div class="embed-settings">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è</h3>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ -->
        <div>
          <label>–†–∞–∑–º–µ—Ä—ã (px):</label>
          <div class="size-controls">
            <input type="number" id="widthInput" placeholder="–®–∏—Ä–∏–Ω–∞" value="640">
            <input type="number" id="heightInput" placeholder="–í—ã—Å–æ—Ç–∞" value="480">
          </div>
        </div>

        <!-- –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ -->
        <div>
          <label>–¢–µ–º–∞:</label>
          <div class="checkbox-group">
            <input type="checkbox" id="darkThemeCheckbox">
            <span>–í–∫–ª—é—á–∏—Ç—å —Ç—ë–º–Ω—É—é —Ç–µ–º—É</span>
          </div>
        </div>

        <!-- –ê–≤—Ç–æ-–ø–æ–≤–æ—Ä–æ—Ç –∏ –∞–≤—Ç–æ-—Å—Ç–∞—Ä—Ç -->
        <div>
          <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:</label>
          <div class="checkbox-group">
            <input type="checkbox" id="autoRotateCheckbox" checked>
            <span>–ê–≤—Ç–æ-–ø–æ–≤–æ—Ä–æ—Ç –∫–∞–º–µ—Ä—ã</span>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="autoStartCheckbox" checked>
            <span>–ê–≤—Ç–æ-—Å—Ç–∞—Ä—Ç</span>
          </div>
        </div>

        <!-- –ü–æ–ª–µ —Å Embed-–∫–æ–¥–æ–º –∏ –∫–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="embed-code-container">
          <label for="embedCode">Embed-–∫–æ–¥:</label>
          <textarea id="embedCode" readonly></textarea>
          <button class="copy-button" id="copyEmbedCode">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const openButton = document.getElementById("openAdvancedEmbed");
    const overlay = document.getElementById("overlay");
    const closeButton = document.getElementById("closeModal");

    openButton.addEventListener("click", () => {
      overlay.style.display = "block";
      generateEmbedCode();
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∏–Ω–∏-–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
      const miniViewer = document.getElementById("miniViewer");
      miniViewer.setAttribute("source", "<%= rails_blob_url(@model.file) %>");
    });

    closeButton.addEventListener("click", () => {
      overlay.style.display = "none";
    });

    // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
    const widthInput = document.getElementById("widthInput");
    const heightInput = document.getElementById("heightInput");
    const darkThemeCheckbox = document.getElementById("darkThemeCheckbox");
    const autoRotateCheckbox = document.getElementById("autoRotateCheckbox");
    const autoStartCheckbox = document.getElementById("autoStartCheckbox");
    const embedCodeTextarea = document.getElementById("embedCode");

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ embed-–∫–æ–¥–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
    [widthInput, heightInput, darkThemeCheckbox, autoRotateCheckbox, autoStartCheckbox].forEach(el => {
      el.addEventListener("change", generateEmbedCode);
      el.addEventListener("keyup", generateEmbedCode);
    });

    function generateEmbedCode() {
      const widthVal = widthInput.value || "640";
      const heightVal = heightInput.value || "480";
      const isDarkTheme = darkThemeCheckbox.checked;
      const isAutoRotate = autoRotateCheckbox.checked;
      const isAutoStart = autoStartCheckbox.checked;

      const embedUrl = "<%= url_for(embed_model_path(@model)) %>" 
        + `?darkTheme=${isDarkTheme}&autoRotate=${isAutoRotate}&autoStart=${isAutoStart}`;

      const embedHTML = `
<iframe
  title="<%= @model.name %>"
  width="${widthVal}" height="${heightVal}"
  frameborder="0"
  allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true"
  src="${embedUrl}">
</iframe>
<p style="font-size: 13px; font-weight: normal; margin: 5px;">
  <a href="${embedUrl}" target="_blank" rel="nofollow">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å 3D –º–æ–¥–µ–ª—å</a> –Ω–∞ Share3D
</p>
      `.trim();

      embedCodeTextarea.value = embedHTML;
    }

    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ embed-–∫–æ–¥–∞
    const copyButton = document.getElementById("copyEmbedCode");
    copyButton.addEventListener("click", () => {
      navigator.clipboard.writeText(embedCodeTextarea.value)
        .then(() => {
          alert("–ö–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
        })
        .catch(err => {
          console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å:", err);
        });
    });
  </script>

  <script>
    (function() {
      // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞
      function initializeBabylonAnalysis() {
        console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ Babylon...");
  
        // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        const viewer = document.querySelector('babylon-viewer');
        const analysisButton = document.getElementById('runAnalysis');
        const analysisResultsElem = document.getElementById('analysisResults');
        const modelUrl = "<%= rails_blob_url(@model.file) %>";
  
        // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º—ã –Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ show) ‚Äî –≤—ã—Ö–æ–¥–∏–º
        if (!analysisButton) return;
  
        // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ü–µ–Ω—É
        function analyzeScene(scene) {
          let totalMeshes = scene.meshes.length;
          let totalVertices = 0;
          let totalIndices = 0;
          let analysisDetails = '';
  
          scene.meshes.forEach(mesh => {
            const meshVertices = (mesh.getTotalVertices && mesh.getTotalVertices()) || 0;
            totalVertices += meshVertices;
  
            const indices = (mesh.getIndices && mesh.getIndices()) || [];
            totalIndices += indices ? indices.length : 0;
  
            let boundingInfo = '';
            if (mesh.getBoundingInfo) {
              const bbox = mesh.getBoundingInfo().boundingBox;
              const min = bbox.minimum;
              const max = bbox.maximum;
              boundingInfo = `–†–∞–∑–º–µ—Ä—ã: (min: [${min.x.toFixed(2)}, ${min.y.toFixed(2)}, ${min.z.toFixed(2)}], max: [${max.x.toFixed(2)}, ${max.y.toFixed(2)}, ${max.z.toFixed(2)}])`;
            }
  
            analysisDetails += `
              <div class="mesh-analysis">
                <strong>–ú–µ—à: ${mesh.name}</strong>
                <p>–í–µ—Ä—à–∏–Ω: ${meshVertices}</p>
                <p>–ò–Ω–¥–µ–∫—Å–æ–≤: ${indices ? indices.length : 0}</p>
                <p>${boundingInfo}</p>
              </div>
              <hr>
            `;
          });
  
          return `
            <p><strong>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—à–µ–π:</strong> ${totalMeshes}</p>
            <p><strong>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ—Ä—à–∏–Ω:</strong> ${totalVertices}</p>
            <p><strong>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–¥–µ–∫—Å–æ–≤:</strong> ${totalIndices}</p>
            <hr>
            ${analysisDetails}
          `;
        }
  
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ü–µ–Ω—ã —á–µ—Ä–µ–∑ BABYLON.SceneLoader.Load
        // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç callback(newScene, engine, canvas)
        function loadSceneManually(sourceUrl, callback) {
          console.log("–ù–∞—á–∏–Ω–∞—é —Ä—É—á–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Å—Ü–µ–Ω—ã —Å URL:", sourceUrl);
  
          // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∫—Ä—ã—Ç—ã–π canvas –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Babylon Engine
          let canvas = document.getElementById("tempCanvas");
          if (canvas) {
            canvas.parentNode.removeChild(canvas);
          }
          canvas = document.createElement('canvas');
          canvas.id = "tempCanvas";
          canvas.style.display = 'none';
          document.body.appendChild(canvas);
  
          const engine = new BABYLON.Engine(canvas, true);
  
          BABYLON.SceneLoader.Load("", sourceUrl, engine,
            function(newScene) {
              console.log("–°—Ü–µ–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
              // –ï—Å–ª–∏ —Å—Ü–µ–Ω–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–∞–º–µ—Ä—ã, –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –∫–∞–º–µ—Ä—É
              if (!newScene.activeCamera) {
                console.log("–ê–∫—Ç–∏–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è—é –¥–µ—Ñ–æ–ª—Ç–Ω—É—é ArcRotateCamera");
                const defaultCamera = new BABYLON.ArcRotateCamera("defaultCamera",
                  Math.PI / 2, Math.PI / 4, 10, BABYLON.Vector3.Zero(), newScene);
                defaultCamera.attachControl(canvas, true);
                newScene.activeCamera = defaultCamera;
                newScene.cameras.push(defaultCamera);
              }
              // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å—Ü–µ–Ω—ã
              newScene.executeWhenReady(function() {
                console.log("–°—Ü–µ–Ω–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞");
                callback(newScene, engine, canvas);
              });
            },
            function(evt) {
              console.log("–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏:", evt);
            },
            function(scene, message) {
              console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏:", message);
              alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: " + message);
              document.body.removeChild(canvas);
            }
          );
        }
  
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑"
        analysisButton.addEventListener('click', () => {
          console.log("–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –∞–Ω–∞–ª–∏–∑–∞. modelUrl:", modelUrl);
  
          // –í—ã–ø–æ–ª–Ω—è–µ–º —Ä—É—á–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Å—Ü–µ–Ω—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
          loadSceneManually(modelUrl, function(newScene, engine, canvas) {
            console.log("–†—É—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –æ–∂–∏–¥–∞—é –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –∞–Ω–∞–ª–∏–∑–æ–º");
            // –ó–∞–¥–µ—Ä–∂–∫–∞ –≤ 300 –º—Å –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ —Å—Ü–µ–Ω—ã
            setTimeout(() => {
              console.log("–ó–∞–ø—É—Å–∫–∞—é –∞–Ω–∞–ª–∏–∑ —Å—Ü–µ–Ω—ã");
              const resultsHTML = analyzeScene(newScene);
              analysisResultsElem.innerHTML = resultsHTML;
  
              // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º render loop, –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º engine –∏ —É–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π canvas
              engine.stopRenderLoop();
              engine.dispose();
              if (canvas && canvas.parentNode) {
                canvas.parentNode.removeChild(canvas);
              }
            }, 2000); // –ó–∞–¥–µ—Ä–∂–∫–∞ 300 –º—Å ‚Äì –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
          });
        });
      }
  
      // –ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Turbo (Hotwire) –∏–ª–∏ Turbolinks, —Å–ª—É—à–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —Å–æ–±—ã—Ç–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
      if (window.Turbo || window.Turbolinks) {
        document.addEventListener('turbo:load', initializeBabylonAnalysis);
        document.addEventListener('turbolinks:load', initializeBabylonAnalysis);
      } else {
        document.addEventListener('DOMContentLoaded', initializeBabylonAnalysis);
      }
    })();
  </script>
</body>
</html>
