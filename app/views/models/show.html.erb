<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= @model.name %> - –ü—Ä–æ—Å–º–æ—Ç—Ä 3D –º–æ–¥–µ–ª–∏</title>

  <!-- Babylon Viewer -->
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@babylonjs/viewer@7.52.1/dist/babylon-viewer.esm.min.js"></script>
</head>

<%= stylesheet_link_tag 'models', media: 'all' %>
<%= stylesheet_link_tag 'model_analysis', media: 'all' %>

<body>
  <div class="model-container" data-controller="model-viewer">
    <h2 class="model-title">–ú–æ–¥–µ–ª—å: <%= @model.name %></h2>
    <div class="model-description">
      <p>–û–ø–∏—Å–∞–Ω–∏–µ: <%= @model.description %></p>
    </div>

    <div class="viewer-container">
      <babylon-viewer
        source="<%= rails_blob_url(@model.file) %>"
        environment="auto"
        camera-auto-orbit
        camera-auto-orbit-speed="0.080"
      </babylon-viewer>
    </div>

    <hr class="separator">

    <div class="action-buttons">
      <% if @model.file.attached? %>
        <a class="download-link" href="<%= rails_blob_path(@model.file, disposition: 'attachment') %>">
          üì• –°–∫–∞—á–∞—Ç—å –º–æ–¥–µ–ª—å
        </a>
      <% else %>
        <p>–§–∞–π–ª –º–æ–¥–µ–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>
      <% end %>
      <button class="embed-button" id="openAdvancedEmbed">üîó Embed</button>
    </div>

    <div class="model-analysis">
      <h3>–ê–Ω–∞–ª–∏–∑ –º–æ–¥–µ–ª–∏</h3>
      
      <div class="analysis-buttons">
        <button id="runBasicAnalysis" class="analysis-button" data-model-url="<%= rails_blob_url(@model.file) %>">
          <span class="button-icon">üìä</span> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª–∏–≥–æ–Ω–∞–ª—å–Ω–æ–π —Å–µ—Ç–∫–∏
        </button>
        <button id="runAdvancedAnalysis" class="analysis-button" data-model-url="<%= rails_blob_url(@model.file) %>">
          <span class="button-icon">‚ö°</span> –û—Ü–µ–Ω–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ç–æ–ø–æ–ª–æ–≥–∏–∏
        </button>
      </div>
      
      <div id="analysisResults" class="analysis-results hidden"></div>
      <div id="advancedAnalysisResults" class="analysis-results hidden"></div>
    </div>    
  </div>

  <!-- Overlay –∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è Embed -->
  <div class="overlay" id="overlay">
    <div class="advanced-embed-modal" id="advancedEmbedModal">
      <button class="close-embed-modal" id="closeModal">‚úï</button>

      <div class="embed-viewer-container">
        <babylon-viewer
          id="miniViewer"
          data-model-url="<%= rails_blob_url(@model.file) %>"
          environment="auto"
          camera-auto-orbit
          camera-auto-orbit-speed="0.070"
        </babylon-viewer>
      </div>

      <div class="embed-settings">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è</h3>

        <div>
          <label>–†–∞–∑–º–µ—Ä—ã (px):</label>
          <div class="size-controls">
            <input type="number" id="widthInput" placeholder="–®–∏—Ä–∏–Ω–∞" value="640">
            <input type="number" id="heightInput" placeholder="–í—ã—Å–æ—Ç–∞" value="480">
          </div>
        </div>

        <div>
          <label>–¢–µ–º–∞:</label>
          <div class="checkbox-group">
            <input type="checkbox" id="darkThemeCheckbox">
            <span>–í–∫–ª—é—á–∏—Ç—å —Ç—ë–º–Ω—É—é —Ç–µ–º—É</span>
          </div>
        </div>

        <div>
          <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:</label>
          <div class="checkbox-group">
            <input type="checkbox" id="autoRotateCheckbox" checked>
            <span>–ê–≤—Ç–æ-–ø–æ–≤–æ—Ä–æ—Ç –∫–∞–º–µ—Ä—ã</span>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="autoStartCheckbox" checked>
            <span>–ê–≤—Ç–æ-—Å—Ç–∞—Ä—Ç</span>
          </div>
        </div>

        <div class="embed-code-container">
          <label for="embedCode">Embed-–∫–æ–¥:</label>
          <textarea 
            id="embedCode" 
            readonly 
            data-embed-url="<%= url_for(embed_model_path(@model)) %>"
            data-model-name="<%= @model.name %>"
          ></textarea>
          <button class="copy-button" id="copyEmbedCode">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
