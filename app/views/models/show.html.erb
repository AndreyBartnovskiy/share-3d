<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= @model.name %> - –ü—Ä–æ—Å–º–æ—Ç—Ä 3D –º–æ–¥–µ–ª–∏</title>

  <!-- Babylon Viewer -->
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@babylonjs/viewer@7.52.1/dist/babylon-viewer.esm.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f4f4f4;
      color: #333;
    }
    .model-container {
      background: #fff;
      max-width: 800px;
      margin: 80px auto; /* —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –≤–µ—Ä—Ö–Ω–∏–π –æ—Ç—Å—Ç—É–ø */
      padding: 20px;
      box-sizing: border-box;
    }
    .model-title {
      font-size: 28px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
    }
    .model-description {
      background: #f9f9f9;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 20px;
    }
    .viewer-container {
      width: 100%;
      height: 500px;
      margin-bottom: 20px;
    }
    babylon-viewer {
      width: 100%;
      height: 100%;
    }
    .separator {
      border: none;
      height: 2px;
      background: #ccc;
      margin: 30px 0;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .download-link, .embed-button {
      display: inline-block;
      padding: 10px 15px;
      text-decoration: none;
      border-radius: 5px;
      font-weight: bold;
      transition: 0.3s;
      border: none;
      cursor: pointer;
    }
    .download-link {
      background: #007bff;
      color: white;
    }
    .download-link:hover {
      background: #0056b3;
    }
    .embed-button {
      background: #28a745;
      color: white;
    }
    .embed-button:hover {
      background: #1e7e34;
    }
    /* –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è Embed */
    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.6);
      z-index: 999;
    }
    .advanced-embed-modal {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 90%;
      max-width: 1000px;
      transform: translate(-50%, -50%);
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: row;
    }
    .embed-viewer-container {
      flex: 1;
      min-width: 400px;
      background: #fafafa;
      border-right: 1px solid #ccc;
      position: relative;
    }
    .embed-viewer-container babylon-viewer {
      width: 100%;
      height: 100%;
    }
    .embed-settings {
      width: 300px;
      padding: 20px;
      background: #fff;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 15px;
      position: relative;
    }
    .embed-settings h3 {
      margin: 0 0 15px;
      font-size: 20px;
    }
    .embed-settings label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .embed-settings .size-controls {
      display: flex;
      gap: 10px;
    }
    .embed-settings input[type="number"] {
      width: 80px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
    }
    .embed-settings .checkbox-group {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .embed-code-container {
      margin-top: auto;
    }
    #embedCode {
      width: 100%;
      height: 100px;
      font-family: monospace;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      overflow-y: auto;
      resize: none;
    }
    .copy-button {
      background: #007bff;
      color: #fff;
      padding: 10px 15px;
      border-radius: 4px;
      text-decoration: none;
      cursor: pointer;
      border: none;
      margin-top: 10px;
    }
    /* –ö–Ω–æ–ø–∫–∞-–∫—Ä–µ—Å—Ç–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è */
    .close-embed-modal {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      cursor: pointer;
      background: transparent;
      border: none;
      font-size: 24px;
      line-height: 1;
      color: #f44336;
    }
  </style>
</head>
<body>
  <div class="model-container">
    <h2 class="model-title">–ú–æ–¥–µ–ª—å: <%= @model.name %></h2>
    <div class="model-description">
      <p>–û–ø–∏—Å–∞–Ω–∏–µ: <%= @model.description %></p>
    </div>

    <div class="viewer-container">
      <babylon-viewer
        source="<%= rails_blob_url(@model.file) %>"
        environment="auto"
        camera-auto-orbit
        camera-auto-orbit-speed="0.080"
        skybox="https://assets.babylonjs.com/environments/environmentSpecular.env">
      </babylon-viewer>
    </div>

    <hr class="separator">

    <div class="action-buttons">
      <% if @model.file.attached? %>
        <a class="download-link" href="<%= rails_blob_path(@model.file, disposition: 'attachment') %>">
          üì• –°–∫–∞—á–∞—Ç—å –º–æ–¥–µ–ª—å
        </a>
      <% else %>
        <p>–§–∞–π–ª –º–æ–¥–µ–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>
      <% end %>
      <button class="embed-button" id="openAdvancedEmbed">üîó Embed</button>
    </div>
  </div>

  <!-- Overlay –∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è Embed -->
  <div class="overlay" id="overlay">
    <div class="advanced-embed-modal" id="advancedEmbedModal">
      <!-- –ö–Ω–æ–ø–∫–∞-–∫—Ä–µ—Å—Ç–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è -->
      <button class="close-embed-modal" id="closeModal">‚úï</button>

      <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –º–∏–Ω–∏-–ø—Ä–æ—Å–º–æ—Ç—Ä –º–æ–¥–µ–ª–∏ -->
      <div class="embed-viewer-container">
        <babylon-viewer
          id="miniViewer"
          environment="auto"
          camera-auto-orbit
          camera-auto-orbit-speed="0.070"
          skybox="https://assets.babylonjs.com/environments/environmentSpecular.env">
        </babylon-viewer>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ embed-–∫–æ–¥ -->
      <div class="embed-settings">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è</h3>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ -->
        <div>
          <label>–†–∞–∑–º–µ—Ä—ã (px):</label>
          <div class="size-controls">
            <input type="number" id="widthInput" placeholder="–®–∏—Ä–∏–Ω–∞" value="640">
            <input type="number" id="heightInput" placeholder="–í—ã—Å–æ—Ç–∞" value="480">
          </div>
        </div>

        <!-- –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ -->
        <div>
          <label>–¢–µ–º–∞:</label>
          <div class="checkbox-group">
            <input type="checkbox" id="darkThemeCheckbox">
            <span>–í–∫–ª—é—á–∏—Ç—å —Ç—ë–º–Ω—É—é —Ç–µ–º—É</span>
          </div>
        </div>

        <!-- –ê–≤—Ç–æ-–ø–æ–≤–æ—Ä–æ—Ç –∏ –∞–≤—Ç–æ-—Å—Ç–∞—Ä—Ç -->
        <div>
          <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:</label>
          <div class="checkbox-group">
            <input type="checkbox" id="autoRotateCheckbox" checked>
            <span>–ê–≤—Ç–æ-–ø–æ–≤–æ—Ä–æ—Ç –∫–∞–º–µ—Ä—ã</span>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="autoStartCheckbox" checked>
            <span>–ê–≤—Ç–æ-—Å—Ç–∞—Ä—Ç</span>
          </div>
        </div>

        <!-- –ü–æ–ª–µ —Å Embed-–∫–æ–¥–æ–º –∏ –∫–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="embed-code-container">
          <label for="embedCode">Embed-–∫–æ–¥:</label>
          <textarea id="embedCode" readonly></textarea>
          <button class="copy-button" id="copyEmbedCode">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const openButton = document.getElementById("openAdvancedEmbed");
    const overlay = document.getElementById("overlay");
    const closeButton = document.getElementById("closeModal");

    openButton.addEventListener("click", () => {
      overlay.style.display = "block";
      generateEmbedCode();
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∏–Ω–∏-–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
      const miniViewer = document.getElementById("miniViewer");
      miniViewer.setAttribute("source", "<%= rails_blob_url(@model.file) %>");
    });

    closeButton.addEventListener("click", () => {
      overlay.style.display = "none";
    });

    // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
    const widthInput = document.getElementById("widthInput");
    const heightInput = document.getElementById("heightInput");
    const darkThemeCheckbox = document.getElementById("darkThemeCheckbox");
    const autoRotateCheckbox = document.getElementById("autoRotateCheckbox");
    const autoStartCheckbox = document.getElementById("autoStartCheckbox");
    const embedCodeTextarea = document.getElementById("embedCode");

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ embed-–∫–æ–¥–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
    [widthInput, heightInput, darkThemeCheckbox, autoRotateCheckbox, autoStartCheckbox].forEach(el => {
      el.addEventListener("change", generateEmbedCode);
      el.addEventListener("keyup", generateEmbedCode);
    });

    function generateEmbedCode() {
      const widthVal = widthInput.value || "640";
      const heightVal = heightInput.value || "480";
      const isDarkTheme = darkThemeCheckbox.checked;
      const isAutoRotate = autoRotateCheckbox.checked;
      const isAutoStart = autoStartCheckbox.checked;

      const embedUrl = "<%= url_for(embed_model_path(@model)) %>" 
        + `?darkTheme=${isDarkTheme}&autoRotate=${isAutoRotate}&autoStart=${isAutoStart}`;

      const embedHTML = `
<iframe
  title="<%= @model.name %>"
  width="${widthVal}" height="${heightVal}"
  frameborder="0"
  allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true"
  src="${embedUrl}">
</iframe>
<p style="font-size: 13px; font-weight: normal; margin: 5px;">
  <a href="${embedUrl}" target="_blank" rel="nofollow">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å 3D –º–æ–¥–µ–ª—å</a> –Ω–∞ My3DViewer
</p>
      `.trim();

      embedCodeTextarea.value = embedHTML;
    }

    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ embed-–∫–æ–¥–∞
    const copyButton = document.getElementById("copyEmbedCode");
    copyButton.addEventListener("click", () => {
      navigator.clipboard.writeText(embedCodeTextarea.value)
        .then(() => {
          alert("–ö–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
        })
        .catch(err => {
          console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å:", err);
        });
    });
  </script>
</body>
</html>
